<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>PixelStrike - 用户管理测试台</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; justify-content: center; align-items: flex-start; padding: 20px; background-color: #f4f7f9; gap: 20px; flex-wrap: wrap; }
        .panel { background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 25px; min-width: 450px; }
        h2 { border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 0; color: #333; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #555; font-weight: 500; }
        input { width: calc(100% - 22px); padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        button { width: 100%; padding: 12px; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; transition: background-color 0.2s; margin-top: 5px; }
        .btn-register { background-color: #28a745; } .btn-register:hover { background-color: #218838; }
        .btn-login { background-color: #007bff; } .btn-login:hover { background-color: #0056b3; }
        .btn-action { background-color: #17a2b8; } .btn-action:hover { background-color: #117a8b; }
        .btn-update { background-color: #ffc107; color: #212529; } .btn-update:hover { background-color: #e0a800; }
        .log-container { height: 200px; overflow-y: auto; border: 1px solid #ddd; background-color: #fdfdfd; padding: 15px; font-family: "Courier New", Courier, monospace; font-size: 13px; line-height: 1.5; margin-top: 20px; }
        .log-entry.error { color: #D8000C; } .log-entry.success { color: #4F8A10; } .log-entry.info { color: #00529B; }
        #profile-section { display: none; } /* 默认隐藏个人信息面板 */
    </style>
</head>
<body>

<div class="panel" id="auth-section">
    <h2>1. 用户注册</h2>
    <div class="form-group"><label for="reg-username">用户名:</label><input type="text" id="reg-username" placeholder="3-20位字符"></div>
    <div class="form-group"><label for="reg-email">邮箱:</label><input type="email" id="reg-email" placeholder="有效的邮箱地址"></div>
    <div class="form-group"><label for="reg-password">密码:</label><input type="password" id="reg-password" placeholder="6-30位字符"></div>
    <div class="form-group"><label for="reg-nickname">昵称:</label><input type="text" id="reg-nickname" placeholder="2-20位字符"></div>
    <button onclick="registerUser()" class="btn-register">注册新用户</button>
    <hr style="margin: 25px 0;">
    <h2>2. 用户登录</h2>
    <div class="form-group"><label for="login-username">用户名:</label><input type="text" id="login-username"></div>
    <div class="form-group"><label for="login-password">密码:</label><input type="password" id="login-password"></div>
    <button onclick="loginUser()" class="btn-login">登录</button>
</div>

<div class="panel" id="profile-section">
    <h2>3. 个人信息管理</h2>
    <p>当前登录: <b id="current-user-info">未登录</b></p>
    <button onclick="fetchMyProfile()" class="btn-action">刷新我的信息</button>
    <hr style="margin: 25px 0;">
    <h3>修改信息</h3>
    <div class="form-group"><label for="update-nickname">新昵称:</label><input type="text" id="update-nickname"></div>
    <div class="form-group"><label for="update-avatar">新头像URL:</label><input type="text" id="update-avatar"></div>
    <button onclick="updateMyProfile()" class="btn-update">确认更新</button>
</div>

<div class="panel">
    <h2>日志输出</h2>
    <div class="log-container" id="log-container"></div>
</div>

<script>
    const API_BASE_URL = 'http://localhost:8080';
    const logContainer = document.getElementById('log-container');
    let authToken = null; // 用于存储登录后的Token

    function log(message, type = 'info') {
        const entry = document.createElement('div');
        entry.className = `log-entry ${type}`;
        entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
        logContainer.prepend(entry);
    }

    // --- 1. 注册逻辑 ---
    async function registerUser() {
        const payload = {
            username: document.getElementById('reg-username').value,
            email: document.getElementById('reg-email').value,
            password: document.getElementById('reg-password').value,
            nickname: document.getElementById('reg-nickname').value
        };
        if (!payload.username || !payload.email || !payload.password || !payload.nickname) {
            log('所有注册字段均为必填项', 'error'); return;
        }
        log(`发送注册请求: ${JSON.stringify(payload)}`, 'info');
        try {
            const response = await fetch(`${API_BASE_URL}/auth/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (result.status === 0) {
                log(`<b>注册成功!</b> ${result.message}`, 'success');
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            log(`注册失败: ${error.message}`, 'error');
        }
    }

    // --- 2. 登录逻辑 ---
    async function loginUser() {
        const payload = {
            username: document.getElementById('login-username').value,
            password: document.getElementById('login-password').value
        };
        if (!payload.username || !payload.password) {
            log('用户名和密码不能为空', 'error'); return;
        }
        log(`发送登录请求...`, 'info');
        try {
            const response = await fetch(`${API_BASE_URL}/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (result.status === 0) {
                authToken = result.data; // 保存Token
                log('<b>登录成功!</b> Token已保存。', 'success');
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('profile-section').style.display = 'block';
                await fetchMyProfile(); // 登录成功后自动获取信息
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            log(`登录失败: ${error.message}`, 'error');
        }
    }

    // --- 3. 获取个人信息 ---
    async function fetchMyProfile() {
        if (!authToken) { log('请先登录', 'error'); return; }
        log('正在获取个人信息...', 'info');
        try {
            const response = await fetch(`${API_BASE_URL}/users/me`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            const result = await response.json();
            if (result.status === 0) {
                const profile = result.data;
                log(`信息获取成功: ${JSON.stringify(profile)}`, 'success');
                document.getElementById('current-user-info').innerText = `${profile.nickname} (ID: ${profile.userId})`;
                document.getElementById('update-nickname').value = profile.nickname;
                document.getElementById('update-avatar').value = profile.avatarUrl || '';
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            log(`获取信息失败: ${error.message}`, 'error');
        }
    }

    // --- 4. 更新个人信息 ---
    async function updateMyProfile() {
        if (!authToken) { log('请先登录', 'error'); return; }
        const payload = {
            nickname: document.getElementById('update-nickname').value,
            avatarUrl: document.getElementById('update-avatar').value
        };
        log(`发送更新请求: ${JSON.stringify(payload)}`, 'info');
        try {
            const response = await fetch(`${API_BASE_URL}/users/me`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (result.status === 0) {
                log(`<b>信息更新成功!</b>`, 'success');
                await fetchMyProfile(); // 更新后自动刷新显示
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            log(`更新失败: ${error.message}`, 'error');
        }
    }
</script>

</body>
</html>