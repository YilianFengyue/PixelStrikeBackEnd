<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>PixelStrike 全功能测试台 (v5)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; justify-content: center; align-items: flex-start; padding: 20px; background-color: #f4f7f9; gap: 20px; flex-wrap: wrap; }
        .panel { background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 25px; }
        .controls { min-width: 320px; }
        .game-container { position: relative; } /* For HUD positioning */
        canvas { background-color: #d0e7ff; border: 2px solid #333; display: block; }
        h2 { border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 0; color: #333; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #555; font-weight: 500; }
        input { width: calc(100% - 22px); padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        .input-group { display: flex; }
        .input-group input { flex-grow: 1; border-top-right-radius: 0; border-bottom-right-radius: 0; }
        .input-group button { width: auto; border-top-left-radius: 0; border-bottom-left-radius: 0; }
        button { width: 100%; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; transition: background-color 0.2s; margin-top: 5px; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        .log-container { height: 250px; overflow-y: auto; border: 1px solid #ddd; background-color: #fdfdfd; padding: 15px; font-family: "Courier New", Courier, monospace; font-size: 13px; line-height: 1.5; margin-top: 15px; }
        .log-entry { margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed #eee; word-break: break-all; }
        .log-entry.error { color: #D8000C; } .log-entry.success { color: #4F8A10; } .log-entry.ws { color: #551A8B; }
        .status-badge { padding: 4px 8px; border-radius: 12px; color: white; font-size: 12px; margin-left: 10px; display: inline-block; }
        .status-connected { background-color: #28a745; } .status-disconnected { background-color: #dc3545; }
        .list-container { list-style: none; padding: 0; max-height: 200px; overflow-y: auto; border: 1px solid #eee; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
        .list-item button { width: auto; padding: 4px 8px; font-size: 12px; margin-top: 0; }
        .friend-status { font-size: 12px; padding: 3px 8px; border-radius: 10px; color: white; }
        .status-ONLINE { background-color: #28a745; } .status-OFFLINE { background-color: #6c757d; } .status-IN_GAME { background-color: #ffc107; color: #000 } .status-MATCHING { background-color: #17a2b8; } .status-IN_ROOM { background-color: #6f42c1; }
        #hud { position: absolute; top: 10px; left: 10px; color: white; font-size: 20px; font-weight: bold; text-shadow: 2px 2px 4px #000; }
        #game-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; background-color: rgba(0,0,0,0.3); color: white; font-size: 80px; font-weight: bold; text-shadow: 3px 3px 6px #000; pointer-events: none; visibility: hidden; }
        #results-container { margin-top: 15px; }
        .results-table { width: 100%; border-collapse: collapse; }
        .results-table th, .results-table td { border: 1px solid #ddd; padding: 8px; text-align: left;}
        .results-table th { background-color: #f2f2f2; }
        .toast-notifications { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .toast { background-color: #333; color: white; padding: 15px; border-radius: 5px; margin-bottom: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 10px; min-width: 300px; }
        .toast-actions button { width: auto; padding: 5px 10px; font-size: 12px; margin: 0 5px; }
        .toast-accept { background-color: #28a745; } .toast-reject { background-color: #dc3545; }
    </style>
</head>
<body>
<div id="toast-container" class="toast-notifications"></div>

<div class="panel controls">
    <div id="login-section">
        <h2>1. 登录</h2>
        <div class="form-group"><label for="login-username">用户名:</label><input type="text" id="login-username" value="xu"></div>
        <div class="form-group"><label for="login-password">密码:</label><input type="password" id="login-password" value="1234"></div>
        <button onclick="loginUser()">登录</button>
    </div>
    <div id="matchmaking-section" style="display: none;">
        <h2>2. 匹配与游戏</h2>
        <p>已登录: <b id="current-user"></b></p>
        <button id="start-match-btn" onclick="startMatchmaking()">开始匹配</button>
        <button id="cancel-match-btn" onclick="cancelMatchmaking()" disabled>取消匹配</button>
        <div style="margin-top: 20px;">
            <h3>操作说明:</h3>
            <p><b>A / D</b>: 左右移动 | <b>W / 空格</b>: 跳跃 | <b>J</b>: 开火</p>
        </div>
    </div>
</div>

<div class="panel game-container">
    <h2>游戏场景</h2>
    <canvas id="game-canvas" width="800" height="600"></canvas>
    <div id="hud"></div>
    <div id="game-overlay"></div>
</div>

<div class="panel" style="min-width: 400px;">
    <h2>大厅信息</h2>
    <p>大厅连接状态: <span id="lobby-ws-status" class="status-badge status-disconnected">未连接</span></p>
    <div id="friends-section" style="display: none;">
        <h3>好友列表</h3>
        <ul id="friend-list" class="list-container"></ul>
    </div>

    <div id="social-section" style="display: none; margin-top: 20px;">
        <h3>社交与自定义房间</h3>
        <div class="form-group">
            <label for="search-nickname">搜索玩家 (按昵称):</label>
            <div class="input-group">
                <input type="text" id="search-nickname" placeholder="输入昵称">
                <button onclick="searchUser()">搜索</button>
            </div>
        </div>
        <ul id="search-results" class="list-container"></ul>
        <hr>
        <div class="form-group">
            <button onclick="createCustomRoom()">创建自定义房间</button>
            <div class="input-group" style="margin-top: 10px;">
                <input type="text" id="created-room-id" placeholder="创建成功后显示房号" readonly>
                <button onclick="copyRoomId()">复制</button>
            </div>
            <button id="start-custom-game-btn" onclick="startCustomGame()" style="display:none; background-color: #28a745;">开始游戏</button>
        </div>
        <div class="form-group">
            <label for="join-room-id">加入房间 (输入房号):</label>
            <div class="input-group">
                <input type="text" id="join-room-id" placeholder="粘贴房号">
                <button onclick="joinCustomRoom()">加入</button>
            </div>
            <button id="leave-custom-room-btn" onclick="leaveCustomRoom()" style="display:none; margin-top: 10px; background-color: #dc3545;">退出房间</button>
        </div>
    </div>

    <div id="results-section" style="display: none;">
        <h3 id="results-title">对局详情</h3>
        <div id="results-container"></div>
        <hr>
        <h3>历史战绩 (点击查询详情)</h3>
        <ul id="match-history-list" class="list-container" style="max-height: 200px;"></ul>
    </div>

    <h2>日志输出</h2>
    <div class="log-container" id="log-container"></div>
</div>

<script>
    const API_BASE_URL = 'http://localhost:8080';
    const WS_BASE_URL = 'ws://localhost:8080';

    let authToken = null, myPlayerId = null, lastGameId = null, ping = 0;
    let lobbySocket = null, gameSocket = null;
    let gameState = { players: {} };
    const keys = { a: false, d: false, w: false, " ": false, j: false };
    let controlsEnabled = false;

    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    const logContainer = document.getElementById('log-container');
    const hud = document.getElementById('hud');
    const gameOverlay = document.getElementById('game-overlay');

    function log(message, type = 'info') {
        const entry = document.createElement('div');
        entry.className = `log-entry ${type}`;
        entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message.replace(/</g, "&lt;").replace(/>/g, "&gt;")}`;
        logContainer.prepend(entry);
    }

    // --- 1. 认证与大厅连接 ---
    async function loginUser() {
        const username = document.getElementById('login-username').value;
        const password = document.getElementById('login-password').value;
        log(`登录用户: ${username}`);
        try {
            const response = await fetch(`${API_BASE_URL}/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const result = await response.json();
            if (response.ok && result.status === 0) {
                onLoginSuccess(username, result.data);
            } else { throw new Error(result.message); }
        } catch (error) { log(`登录失败: ${error.message}`, 'error'); }
    }

    /*function onLoginSuccess(username, token) {
        authToken = token;
        log(`登录成功!`);
        document.getElementById('login-section').style.display = 'none';
        showLobbyView(); // 使用新的函数来显示大厅

        connectLobbySocket();
        fetchMyProfile();
        fetchFriends();
        fetchMatchHistory(); // 登录成功后立刻获取历史战绩
    }*/
    function onLoginSuccess(username, loginData) { // 1. 参数名从 token 改为 loginData，更清晰
        // 2. 从 loginData 对象中正确地提取 token
        authToken = loginData.token;

        log(`登录成功!`);
        document.getElementById('login-section').style.display = 'none';
        showLobbyView();

        // 3. 直接使用登录返回的 userProfile 更新UI，无需再次请求
        const userProfile = loginData.userProfile;
        if (userProfile) {
            document.getElementById('current-user').innerText = userProfile.nickname;
        } else {
            document.getElementById('current-user').innerText = username; // 备用方案
        }

        // 4. 连接WebSocket并获取好友和战绩列表 (不再需要单独调用fetchMyProfile)
        connectLobbySocket();
        fetchFriends();
        fetchMatchHistory();
    }

    function showLobbyView() {
        document.getElementById('matchmaking-section').style.display = 'block';
        document.getElementById('social-section').style.display = 'block';
        document.getElementById('friends-section').style.display = 'block';
        document.getElementById('results-section').style.display = 'block';

        // 隐藏游戏结束的浮层
        gameOverlay.style.visibility = 'hidden';
    }

    // 获取自己的Profile
    async function fetchMyProfile() {
        const response = await fetch(`${API_BASE_URL}/users/me`, { headers: { 'Authorization': `Bearer ${authToken}` } });
        const result = await response.json();
        if (result.status === 0) {
            document.getElementById('current-user').innerText = result.data.nickname;
        }
    }

    function connectLobbySocket() {
        const lobbyWsUrl = `${WS_BASE_URL}/ws?token=${authToken}`;
        log(`连接到大厅...`);
        lobbySocket = new WebSocket(lobbyWsUrl);
        lobbySocket.onopen = () => {
            log('大厅连接成功!', 'success');
            document.getElementById('lobby-ws-status').textContent = '已连接';
            document.getElementById('lobby-ws-status').className = 'status-badge status-connected';
        };
        lobbySocket.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            log(`收到大厅通知: <pre>${JSON.stringify(msg, null, 2)}</pre>`, 'ws');
            switch(msg.type) {
                case 'game_start':
                case 'match_success':
                    log(`<b>匹配成功!</b> 准备进入游戏...`, 'success');
                    lastGameId = msg.gameId;
                    connectGameWebSocket(msg.gameId);
                    document.getElementById('start-match-btn').disabled = false;
                    document.getElementById('cancel-match-btn').disabled = true;
                    document.getElementById('results-section').style.display = 'none';
                    break;
                case 'status_update': updateFriendStatus(msg.userId, msg.status); break;
                case 'new_friend_request':
                    // 【修复】使用新的通知系统
                    createToast(`收到来自 <b>${msg.senderNickname}</b> 的好友请求`, [
                        { text: '同意', class: 'toast-accept', action: () => handleFriendRequest(msg.senderId, 'accept') },
                        { text: '拒绝', class: 'toast-reject', action: () => handleFriendRequest(msg.senderId, 'reject') }
                    ]);
                    break;
                case 'friend_request_accepted':
                    createToast(`<b>${msg.acceptorNickname}</b> 已接受您的好友请求!`);
                    fetchFriends();
                    break;
                case 'friend_request_rejected':
                    createToast(`<b>${msg.rejectorNickname}</b> 拒绝了您的好友请求。`);
                    break;
                case 'room_disbanded':
                    log(`<b>房间已解散: ${msg.reason}</b>`, 'error');
                    alert(`房间已解散: ${msg.reason}`);
                    // UI重置
                    document.getElementById('start-custom-game-btn').style.display = 'none';
                    document.getElementById('leave-custom-room-btn').style.display = 'none';
                    break;
            }
        };
        lobbySocket.onclose = () => {
            log('大厅连接断开。', 'error');
            document.getElementById('lobby-ws-status').textContent = '未连接';
            document.getElementById('lobby-ws-status').className = 'status-badge status-disconnected';
        };
    }

    // --- 2. 好友系统 ---
    async function fetchFriends() {
        log('正在获取好友列表...');
        try {
            const response = await fetch(`${API_BASE_URL}/friends`, { headers: { 'Authorization': `Bearer ${authToken}` } });
            const result = await response.json();
            if (result.status === 0) {
                const friendList = document.getElementById('friend-list');
                friendList.innerHTML = '';
                if (!result.data || result.data.length === 0) {
                    friendList.innerHTML = '<li>没有好友</li>'; return;
                }
                result.data.forEach(friend => {
                    const li = document.createElement('li');
                    li.className = 'friend-item';
                    li.id = `friend-${friend.userId}`;
                    li.innerHTML = `<span>${friend.nickname}</span><span class="friend-status status-${friend.onlineStatus || 'OFFLINE'}">${friend.onlineStatus || '离线'}</span>`;
                    friendList.appendChild(li);
                });
            } else { throw new Error(result.message); }
        } catch(error) { log(`获取好友列表失败: ${error.message}`, 'error'); }
    }

    function updateFriendStatus(userId, status) {
        const friendItem = document.getElementById(`friend-${userId}`);
        if (friendItem) {
            const statusBadge = friendItem.querySelector('.friend-status');
            statusBadge.className = `friend-status status-${status || 'OFFLINE'}`;
            statusBadge.textContent = status || '离线';
        }
    }

    // 【新增】好友请求处理函数
    async function handleFriendRequest(senderId, decision) {
        const url = `${API_BASE_URL}/friends/requests/${senderId}/${decision === 'accept' ? 'accept' : 'reject'}`;
        const method = decision === 'accept' ? 'PUT' : 'DELETE';
        log(`${decision === 'accept' ? '同意' : '拒绝'} ID为 ${senderId} 的好友请求`);
        await fetch(url, { method, headers: { 'Authorization': `Bearer ${authToken}` } });
        fetchFriends(); // 刷新好友列表
    }

    // 【新增】通知UI系统
    function createToast(message, actions = []) {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast';

        let messageHTML = `<span>${message}</span>`;

        if (actions.length > 0) {
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'toast-actions';
            actions.forEach(act => {
                const button = document.createElement('button');
                button.className = act.class;
                button.textContent = act.text;
                button.onclick = () => {
                    act.action();
                    toast.remove();
                };
                actionsDiv.appendChild(button);
            });
            toast.innerHTML = messageHTML;
            toast.appendChild(actionsDiv);
        } else {
            toast.innerHTML = messageHTML;
        }

        toastContainer.appendChild(toast);

        setTimeout(() => {
            if (toast) toast.remove();
        }, 8000);
    }



    // 搜索用户
    async function searchUser() {
        const nickname = document.getElementById('search-nickname').value;
        if (!nickname) return;
        log(`搜索玩家: ${nickname}`);
        // 【修复】添加了 Authorization Header
        const response = await fetch(`${API_BASE_URL}/friends/search?nickname=${nickname}`, { headers: { 'Authorization': `Bearer ${authToken}` } });
        const result = await response.json();
        const resultsList = document.getElementById('search-results');
        resultsList.innerHTML = '';
        if (result.data && result.data.length > 0) {
            result.data.forEach(user => {
                const li = document.createElement('li');
                li.className = 'list-item';
                li.innerHTML = `<span>${user.nickname} (ID: ${user.userId})</span> <button onclick="sendFriendRequest(${user.userId})">加好友</button>`;
                resultsList.appendChild(li);
            });
        } else {
            resultsList.innerHTML = '<li>未找到玩家</li>';
        }
    }

    // 发送好友请求
    async function sendFriendRequest(userId) {
        log(`发送好友请求给 ID: ${userId}`);
        const response = await fetch(`${API_BASE_URL}/friends/requests/${userId}`, { method: 'POST', headers: { 'Authorization': `Bearer ${authToken}` } });
        const result = await response.json();
        if (result.status === 0) {
            log('好友请求发送成功!', 'success');
        } else {
            log(`发送失败: ${result.message}`, 'error');
        }
    }

    // --- 3. 匹配与游戏连接 ---
    async function startMatchmaking() {
        log('请求开始匹配...');
        document.getElementById('start-match-btn').disabled = true;
        document.getElementById('cancel-match-btn').disabled = false;
        await fetch(`${API_BASE_URL}/matchmaking/start`, { method: 'POST', headers: { 'Authorization': `Bearer ${authToken}` } });
    }
    async function cancelMatchmaking() {
        log('请求取消匹配...');
        document.getElementById('start-match-btn').disabled = false;
        document.getElementById('cancel-match-btn').disabled = true;
        await fetch(`${API_BASE_URL}/matchmaking/cancel`, { method: 'POST', headers: { 'Authorization': `Bearer ${authToken}` } });
    }

    // 创建自定义房间
    async function createCustomRoom() {
        log('正在创建自定义房间...');
        const response = await fetch(`${API_BASE_URL}/custom-room/create`, { method: 'POST', headers: { 'Authorization': `Bearer ${authToken}` } });
        const result = await response.json();
        if (result.status === 0) {
            const roomId = result.data;
            log(`房间创建成功! 房号: <b>${roomId}</b>`, 'success');
            document.getElementById('created-room-id').value = roomId;
            document.getElementById('start-custom-game-btn').style.display = 'block'; // 显示开始按钮
            document.getElementById('leave-custom-room-btn').style.display = 'block';
        } else {
            log(`创建失败: ${result.message}`, 'error');
            alert(result.message);
        }
    }

    // 复制房号到剪贴板
    function copyRoomId() {
        const roomIdInput = document.getElementById('created-room-id');
        if (roomIdInput.value) {
            navigator.clipboard.writeText(roomIdInput.value).then(() => {
                log('房号已复制到剪贴板!', 'success');
            }, (err) => {
                log('复制失败: ' + err, 'error');
            });
        }
    }

    // 加入自定义房间
    async function joinCustomRoom() {
        const roomId = document.getElementById('join-room-id').value;
        if (!roomId) return;
        log(`正在加入房间: ${roomId}`);
        const response = await fetch(`${API_BASE_URL}/custom-room/join?roomId=${roomId}`, { method: 'POST', headers: { 'Authorization': `Bearer ${authToken}` } });
        const result = await response.json();
        if (result.status === 0) {
            log('加入房间成功!', 'success');
            document.getElementById('leave-custom-room-btn').style.display = 'block';
        } else {
            log(`加入失败: ${result.message}`, 'error');
            alert(result.message);
        }
    }

    // 开始自定义游戏
    async function startCustomGame() {
        const roomId = document.getElementById('created-room-id').value;
        if (!roomId) {
            alert("没有已创建的房间!");
            return;
        }
        log(`房主开始游戏，房号: ${roomId}`);
        await fetch(`${API_BASE_URL}/custom-room/start-game`, { method: 'POST', headers: { 'Authorization': `Bearer ${authToken}` } });
    }

    // 退出自定义房间
    async function leaveCustomRoom() {
        log('请求退出房间...');
        const response = await fetch(`${API_BASE_URL}/custom-room/leave`, { method: 'POST', headers: { 'Authorization': `Bearer ${authToken}` }});
        const result = await response.json();
        if (result.status === 0) {
            log('成功退出房间', 'success');
            // UI重置：隐藏开始游戏和退出按钮
            document.getElementById('start-custom-game-btn').style.display = 'none';
            document.getElementById('leave-custom-room-btn').style.display = 'none';
        } else {
            log(`退出失败: ${result.message}`, 'error');
            alert(result.message);
        }
    }

    function connectGameWebSocket(gameId) {
        if(gameSocket) gameSocket.close();

        const gameWsUrl = `${WS_BASE_URL}/game?gameId=${gameId}&token=${authToken}`;
        log(`连接到游戏...`);
        gameSocket = new WebSocket(gameWsUrl);

        gameSocket.onopen = () => { log('游戏连接成功!', 'success'); controlsEnabled = false; };

        gameSocket.onmessage = (event) => {
            const msg = JSON.parse(event.data);

            if (msg.type === 'welcome') {
                myPlayerId = msg.playerId;
                log(`<b>成功识别我的玩家ID: ${myPlayerId.substring(0, 8)}</b>`, 'success');
                return;
            }
            if (msg.type === 'pong') {
                ping = Date.now() - msg.timestamp;
                return;
            }

            gameState = msg;
        };

        gameSocket.onclose = () => {
            log('游戏连接断开 (游戏结束)。', 'error');
            myPlayerId = null;
            controlsEnabled = false;

            // 1. 显示 GAME OVER 2秒钟给用户反馈
            gameOverlay.textContent = "GAME OVER";
            gameOverlay.style.visibility = 'visible';

            // 2. 延迟2秒后执行返回大厅的操作
            setTimeout(() => {
                log('正在返回大厅...');
                showLobbyView(); // 调用UI切换函数返回大厅

                // 3. 自动刷新历史战绩列表
                fetchMatchHistory();

                // 4. 自动查询刚刚结束的这一局的详细战绩
                if (lastGameId) {
                    fetchMatchResults(lastGameId);
                }
            }, 2000); // 延迟2000毫秒
        };
    }

    async function fetchMatchHistory() {
        log('正在获取历史战绩...');
        const historyList = document.getElementById('match-history-list');
        historyList.innerHTML = '<li>正在加载...</li>'; // 提示用户
        try {
            const response = await fetch(`${API_BASE_URL}/matches/me`, { headers: { 'Authorization': `Bearer ${authToken}` } });
            const result = await response.json();
            if (result.status === 0) {
                historyList.innerHTML = ''; // 清空列表
                if (result.data && result.data.length > 0) {
                    result.data.forEach(match => {
                        const li = document.createElement('li');
                        li.className = 'list-item';
                        // 格式化时间
                        const date = new Date(match.startTime).toLocaleString();
                        li.innerHTML = `<span>${date} - ${match.gameMode} (K/D: ${match.kills}/${match.deaths})</span>`;
                        li.style.cursor = 'pointer';
                        // 为每个列表项添加点击事件，点击后查询该局详情
                        li.onclick = () => fetchMatchResults(match.matchId);
                        historyList.appendChild(li);
                    });
                } else {
                    historyList.innerHTML = '<li>暂无历史战绩</li>';
                }
            } else { throw new Error(result.message); }
        } catch (error) {
            log(`获取历史战绩失败: ${error.message}`, 'error');
            historyList.innerHTML = '<li>加载失败</li>';
        }
    }

    // --- 4. 客户端输入与渲染 ---
    // Ping 发送逻辑
    setInterval(() => {
        if (gameSocket && gameSocket.readyState === WebSocket.OPEN) {
            gameSocket.send(JSON.stringify({ type: 'ping', timestamp: Date.now() }));
        }
    }, 2000);

    setInterval(() => {
        if (!gameSocket || gameSocket.readyState !== WebSocket.OPEN || !controlsEnabled) return;
        let moveInput = 0;
        if (keys.d) moveInput = 1; if (keys.a) moveInput = -1;
        let actions = 0;
        if (keys.w || keys[' ']) actions |= 1;
        if (keys.j) actions |= 2;
        gameSocket.send(JSON.stringify({ moveInput, actions }));
        keys.w = keys[' '] = keys.j = false;
    }, 50);

    window.addEventListener('keydown', (e) => { if (keys.hasOwnProperty(e.key.toLowerCase())) keys[e.key.toLowerCase()] = true; });
    window.addEventListener('keyup', (e) => { if (keys.hasOwnProperty(e.key.toLowerCase())) keys[e.key.toLowerCase()] = false; });


    function gameLoop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#785b40';
        ctx.fillRect(0, 500, canvas.width, 100);

        if (gameState.players) {
            for (const playerId in gameState.players) {
                const p = gameState.players[playerId];
                ctx.fillStyle = (playerId === myPlayerId) ? '#007bff' : '#dc3545';
                ctx.fillRect(p.x - 20, p.y - 40, 40, 40);

                ctx.fillStyle = '#f00'; ctx.fillRect(p.x - 20, p.y - 55, 40, 5);
                ctx.fillStyle = '#0f0'; ctx.fillRect(p.x - 20, p.y - 55, 40 * (p.health / 100), 5);

                ctx.fillStyle = '#000'; ctx.font = '12px sans-serif'; ctx.textAlign = 'center';
                ctx.fillText(p.currentAction, p.x, p.y - 65);
            }
        }

        if (gameState.countdownSeconds != null && gameState.countdownSeconds > 0) {
            gameOverlay.textContent = gameState.countdownSeconds;
            gameOverlay.style.visibility = 'visible';
            controlsEnabled = false;
        } else if (gameState.countdownSeconds === 0) {
            gameOverlay.textContent = "START!";
            gameOverlay.style.visibility = 'visible';
            controlsEnabled = true;
            setTimeout(() => { gameOverlay.style.visibility = 'hidden'; }, 1000);
        }

        if (myPlayerId && gameState.players[myPlayerId]) {
            const me = gameState.players[myPlayerId];
            let hudText = `HP: ${me.health} | Ammo: ${me.ammo} | K/D: ${me.kills}/${me.deaths} | Ping: ${ping}ms`;

            // 新增：如果 gameState 中有 gameTimeRemainingSeconds，则显示它
            if (gameState.gameTimeRemainingSeconds != null) {
                const minutes = Math.floor(gameState.gameTimeRemainingSeconds / 60);
                const seconds = gameState.gameTimeRemainingSeconds % 60;
                // 将秒格式化为两位数
                const formattedTime = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                hudText += ` | Time: ${formattedTime}`;
            }

            hud.innerHTML = hudText;        } else if (!gameSocket || gameSocket.readyState !== WebSocket.OPEN) {
            hud.innerHTML = '等待加入游戏...';
        }

        requestAnimationFrame(gameLoop);
    }

    // 查询战绩的函数
    async function fetchMatchResults(matchId) {
        if (!matchId) { log('没有可查询的游戏ID。', 'error'); return; }
        log(`正在查询游戏 [${matchId}] 的战绩...`);
        document.getElementById('results-section').style.display = 'block';
        try {
            const response = await fetch(`${API_BASE_URL}/matches/${matchId}/results`, { headers: { 'Authorization': `Bearer ${authToken}` } });
            const result = await response.json();
            if (result.status === 0) {
                log('战绩查询成功!', 'success');
                const resultsContainer = document.getElementById('results-container');
                let tableHTML = '<table class="results-table"><tr><th>排名</th><th>玩家昵称</th><th>击杀</th><th>死亡</th></tr>';
                result.data.forEach(p => {
                    tableHTML += `<tr><td>${p.ranking}</td><td>${p.nickname}</td><td>${p.kills}</td><td>${p.deaths}</td></tr>`;
                });
                tableHTML += '</table>';
                resultsContainer.innerHTML = tableHTML;
                document.getElementById('results-title').innerText = `对局 [${matchId}] 详情`;
            } else { throw new Error(result.message); }
        } catch (error) {
            log(`查询战绩失败: ${error.message}`, 'error');
            document.getElementById('results-container').innerHTML = `<p style="color:red;">查询失败</p>`;
        }
    }

    gameLoop();
</script>
</body>
</html>